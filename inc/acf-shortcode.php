<?php
/**
 * Plugin Name: ACF Shortcode
 * Description: Шорткод [sf] для вывода полей ACF в контенте страниц и постов
 * Version: 1.0.1
 * Author: Custom Development
 * License: GPL v2 or later
 */

// Запрет прямого доступа к файлу
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Шорткод для вывода полей ACF
 *
 * Позволяет выводить значения полей ACF из настроек сайта, текущего поста
 * или из конкретного поста по ID через шорткод [sf].
 *
 * @param array $atts Атрибуты шорткода
 * @return string Значение поля ACF или пустая строка
 *
 * ============================================================================
 * ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ:
 * ============================================================================
 *
 * 1. ВЫВОД ПОЛЯ ИЗ НАСТРОЕК САЙТА (по умолчанию):
 *    [sf field="contact_email"]
 *    Результат: info@example.com
 *
 * 2. ВЫВОД ТЕЛЕФОНА С УДАЛЕНИЕМ ВСЕХ СИМВОЛОВ КРОМЕ ЦИФР:
 *    [sf field="phone_number" format="digits_only"]
 *    Исходное: +7 (999) 123-45-67
 *    Результат: 79991234567
 *
 * 3. ВЫВОД ТЕЛЕФОНА В ССЫЛКЕ:
 *    <a href="tel:[sf field='phone_number' format='digits_only']">
 *        [sf field="phone_number"]
 *    </a>
 *    Результат: <a href="tel:79991234567">+7 (999) 123-45-67</a>
 *
 * 4. ВЫВОД ПОЛЯ ИЗ ТЕКУЩЕГО ПОСТА:
 *    [sf field="custom_title" where="post"]
 *    Берет значение поля custom_title из текущей страницы/записи
 *
 * 5. ВЫВОД ПОЛЯ ИЗ КОНКРЕТНОГО ПОСТА ПО ID:
 *    [sf field="custom_title" where="post" id="123"]
 *    Берет значение поля custom_title из поста с ID 123
 *
 * 6. ВЫВОД ПОЛЯ ИЗ ДРУГОГО ПОСТА (короткая форма):
 *    [sf field="author_name" id="456"]
 *    Берет значение из поста 456 (where="post" подразумевается)
 *
 * 7. ВЫВОД В ТЕКСТЕ:
 *    Свяжитесь с нами: [sf field="contact_email"]
 *    Или позвоните: [sf field="phone_number"]
 *
 * 8. ВЫВОД АДРЕСА:
 *    [sf field="address"]
 *
 * 9. ВЫВОД ФУТЕРА:
 *    [sf field="footer_text"]
 *
 * 10. ВЫВОД ПОЛЯ ИЗ ТАКСОНОМИИ (на странице архива):
 *     [sf field="banner_text" where="term"]
 *     Берет значение из текущей таксономии/категории/метки
 *
 * ============================================================================
 * АТРИБУТЫ:
 * ============================================================================
 * - field   (обязательно) - имя поля ACF
 * - format  (опционально) - формат вывода:
 *   * 'digits_only' - только цифры (для телефонов в href)
 * - where   (опционально) - откуда брать поле:
 *   * пусто или 'options' - из настроек сайта (по умолчанию)
 *   * 'post' - из поста (текущего или указанного через id)
 *   * 'term' - из текущей таксономии (для страниц архивов)
 * - id      (опционально) - ID конкретного поста
 *   * если указан - берет поле из этого поста (where="post" автоматически)
 *   * если не указан - берет из текущего поста или options
 * - prefix  (опционально) - текст, добавляемый перед значением
 *   * выводится только если поле имеет значение
 *   * пример: [sf field="phone" prefix="Тел: "] → Тел: +7 999 123-45-67
 * - replace (опционально) - замена текста в формате "что|на_что"
 *   * пример: [sf field="text" replace="машин|автомобилей"]
 *   * "100 машин" → "100 автомобилей"
 *
 * ============================================================================
 */
function custom_acf_field_shortcode($atts) {
    // Проверяем, что ACF активен
    if (!function_exists('get_field')) {
        return '';
    }

    // Устанавливаем атрибуты с умолчаниями
    $atts = shortcode_atts(
        array(
            'field'   => '',         // Имя ACF-поля
            'format'  => '',         // Опциональный формат (digits_only)
            'where'   => '',         // Откуда брать поле (post, term или options)
            'id'      => 0,          // ID конкретного поста
            'prefix'  => '',         // Текст перед значением
            'replace' => ''          // Замена текста (что|на_что)
        ),
        $atts,
        'sf'                         // Имя шорткода
    );

    // Проверяем, что указано имя поля
    if (empty($atts['field'])) {
        return '';
    }

    // Преобразуем ID в число
    $post_id = intval($atts['id']);

    // Получаем значение поля
    if ($post_id > 0) {
        // Если указан ID - берем из конкретного поста
        $value = get_field($atts['field'], $post_id);
    } elseif ($atts['where'] === 'post') {
        // Из текущего поста - ТОЛЬКО на единичных страницах
        if (is_singular()) {
            $value = get_field($atts['field'], get_the_ID());
        } else {
            // На архивах/таксономиях нет "текущего поста"
            return '';
        }
    } elseif ($atts['where'] === 'term') {
        // Из термина таксономии (для страниц архивов)
        $term = get_queried_object();
        if ($term && isset($term->term_id)) {
            $value = get_field($atts['field'], $term);
        } else {
            return '';
        }
    } else {
        // Из настроек сайта (options)
        $value = get_field($atts['field'], 'options');
    }

    // Если значения нет, возвращаем пустую строку
    if (!$value) {
        return '';
    }

    // Применяем замену текста (если указана)
    if (!empty($atts['replace']) && strpos($atts['replace'], '|') !== false) {
        $parts = explode('|', $atts['replace'], 2);
        $value = str_replace($parts[0], $parts[1], $value);
    }

    // Применяем форматирование
    if ($atts['format'] === 'digits_only') {
        // Удаляем все кроме цифр и знака +
        $value = preg_replace('/[^0-9+]/', '', $value);
    }

    // Добавляем префикс (если указан)
    if (!empty($atts['prefix'])) {
        $value = $atts['prefix'] . $value;
    }

    // Возвращаем значение
    return esc_html($value);
}

// Регистрируем шорткод [sf] (site field)
add_shortcode('sf', 'custom_acf_field_shortcode');